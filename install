#!/bin/bash

# Improved error handling function
handle_error() {
    local line_content=$(sed -n "${LINENO}p" "$0")
    echo "An error occurred at line $LINENO: $line_content. Exiting..." >&2
    exit 1
}

# Setup a trap to catch errors and execute handle_error function
trap 'handle_error $LINENO' ERR

# Update package database and install necessary packages
pacman -Sy
pacman -S --noconfirm archlinux-keyring python archinstall git

# Clone dotfiles repository
git clone https://github.com/nhkduy201/dotfiles

# Update user credentials in the configuration file
sed -i "s/\"!root-password\": \"password\"/\"!root-password\": \"$MY_PASSWORD\"/" dotfiles/user_credentials.json
sed -i "s/\"!password\": \"password\"/\"!password\": \"$MY_PASSWORD\"/" dotfiles/user_credentials.json

# Run archinstall with the provided configuration and credentials
archinstall --config dotfiles/user_configuration.json --creds dotfiles/user_credentials.json --silent

# Save SSID and passphrase
mkdir -p /mnt/archinstall/home/$MY_USER
mv dotfiles /mnt/archinstall/home/$MY_USER
iwctl station wlan0 show | grep 'Connected to' | sed 's/.*Connected to\s*//' | sed 's/\s*$//' > /mnt/archinstall/home/$MY_USER/wifi_ssid
grep Passphrase /var/lib/iwd/"$(iwctl station wlan0 show | grep 'Connected network' | sed 's/.*Connected network\s*//' | sed 's/\s*$//').psk" | sed 's/.*Passphrase=//' > /mnt/archinstall/home/$MY_USER/wifi_password

# Create the one-time systemd service
cat <<EOF > /mnt/archinstall/etc/systemd/system/one-time-command.service
[Unit]
Description=Run a one-time command after reboot

[Service]
Type=oneshot
User=$MY_USER
Group=$MY_USER
WorkingDirectory=/home/$MY_USER/dotfiles
ExecStart=/usr/bin/sudo /home/$MY_USER/dotfiles/post_install -a
ExecStartPost=/bin/sh -c 'rm -f /etc/systemd/system/one-time-command.service && systemctl daemon-reload'

[Install]
WantedBy=multi-user.target
EOF

# Enable the one-time systemd service
arch-chroot /mnt/archinstall systemctl enable one-time-command.service

# Correctly add a sudoers rule for $MY_USER
arch-chroot /mnt/archinstall echo "$MY_USER ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/00_$MY_USER_nopasswd

# Reboot the system
reboot
