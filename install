#!/bin/bash

# Improved error handling function
handle_error() {
    local line_content=$(sed -n "${LINENO}p" "$0")
    echo "An error occurred at line $LINENO: $line_content. Exiting..." >&2
    exit 1
}

# Setup a trap to catch errors and execute handle_error function
trap 'handle_error $LINENO' ERR

# Update package database and install necessary packages
pacman -Sy
pacman -S --noconfirm archlinux-keyring python archinstall git

# Clone dotfiles repository
git clone https://github.com/nhkduy201/dotfiles

# Update user credentials in the configuration file
sed -i "s/\"!root-password\": \"password\"/\"!root-password\": \"$PASSWORD\"/" dotfiles/user_credentials.json
sed -i "s/\"!password\": \"password\"/\"!password\": \"$PASSWORD\"/" dotfiles/user_credentials.json

# Run archinstall with the provided configuration and credentials
archinstall --config dotfiles/user_configuration.json --creds dotfiles/user_credentials.json --silent

# Save SSID and passphrase
mkdir -p /mnt/archinstall/home/kayd
iwctl station wlan0 show | grep 'Connected to' | sed 's/.*Connected to //' > /mnt/archinstall/home/kayd/wifi_ssid
grep Passphrase /var/lib/iwd/"$(iwctl station wlan0 show | grep 'Connected network' | sed 's/.*Connected network\s*//' | sed 's/\s*$//').psk" | sed 's/.*Passphrase=//' > /mnt/archinstall/home/kayd/wifi_password

# Create the one-time systemd service
cat <<EOF > /mnt/archinstall/etc/systemd/system/one-time-command.service
[Unit]
Description=Run a one-time command after reboot

[Service]
Type=oneshot
WorkingDirectory=/home/kayd/dotfiles
ExecStart=/usr/bin/sudo /bin/bash /home/kayd/dotfiles/post_install -a
ExecStartPost=/bin/sh -c 'rm -f /etc/systemd/system/one-time-command.service && systemctl daemon-reload'

[Install]
WantedBy=multi-user.target
EOF

# Enable the one-time systemd service
arch-chroot /mnt/archinstall systemctl enable one-time-command.service

# Reboot the system
reboot